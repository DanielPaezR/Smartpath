import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';

// Interfaces para los datos
interface DashboardOverview {
  active_advisors: number;
  active_routes: number;
  total_stores_today: number;
  completed_stores: number;
  in_progress_stores: number;
  avg_visit_duration: number;
}

// Componente de tarjeta reutilizable
interface DashboardCardProps {
  title: string;
  description: string;
  onClick: () => void;
  icon?: string;
}

const DashboardCard: React.FC<DashboardCardProps> = ({ title, description, onClick, icon }) => {
  return (
    <div 
      onClick={onClick}
      style={{
        border: '1px solid #e1e5e9',
        borderRadius: '12px',
        padding: '25px',
        cursor: 'pointer',
        transition: 'all 0.3s ease',
        backgroundColor: '#ffffff',
        boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
      }}
      onMouseEnter={(e) => {
        e.currentTarget.style.transform = 'translateY(-4px)';
        e.currentTarget.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
        e.currentTarget.style.borderColor = '#3b82f6';
      }}
      onMouseLeave={(e) => {
        e.currentTarget.style.transform = 'translateY(0)';
        e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
        e.currentTarget.style.borderColor = '#e1e5e9';
      }}
    >
      <div style={{ display: 'flex', alignItems: 'center', marginBottom: '15px' }}>
        {icon && <span style={{ fontSize: '24px', marginRight: '12px' }}>{icon}</span>}
        <h3 style={{ 
          margin: 0, 
          color: '#1f2937', 
          fontSize: '18px',
          fontWeight: '600'
        }}>
          {title}
        </h3>
      </div>
      <p style={{ 
        margin: 0, 
        color: '#6b7280', 
        fontSize: '14px',
        lineHeight: '1.5'
      }}>
        {description}
      </p>
    </div>
  );
};

const AdminDashboard: React.FC = () => {
  const navigate = useNavigate();
  const [dashboardData, setDashboardData] = useState<DashboardOverview | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Funci√≥n simple para cargar los datos
  const loadDashboardData = async () => {
    try {
      setLoading(true);
      setError(null);
      
      console.log('üîÑ Cargando datos del dashboard...');
      
      const token = localStorage.getItem('token');
      if (!token) {
        throw new Error('No hay token de autenticaci√≥n');
      }

      const response = await fetch('https://smartpath-backend.onrender.com/api/admin/dashboard/overview', {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      });

      console.log('üìä Status:', response.status);

      if (!response.ok) {
        throw new Error(`Error ${response.status}: ${response.statusText}`);
      }

      const data: DashboardOverview = await response.json();
      console.log('‚úÖ Datos recibidos:', data);
      
      setDashboardData(data);
    } catch (err) {
      console.error('‚ùå Error cargando dashboard:', err);
      setError(err instanceof Error ? err.message : 'Error desconocido');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadDashboardData();
  }, []);

  const handleRetry = () => {
    loadDashboardData();
  };

  return (
    <div style={{ 
      padding: '30px', 
      maxWidth: '1200px', 
      margin: '0 auto',
      minHeight: '100vh',
      backgroundColor: '#f8fafc'
    }}>
      {/* Header */}
      <div style={{ marginBottom: '40px' }}>
        <h1 style={{ 
          margin: '0 0 8px 0', 
          color: '#1f2937',
          fontSize: '32px',
          fontWeight: '700'
        }}>
          Panel de Administraci√≥n
        </h1>
        <p style={{ 
          margin: 0, 
          color: '#6b7280',
          fontSize: '16px'
        }}>
          SmartPath - Sistema de Optimizaci√≥n de Rutas para Vitamarket
        </p>
      </div>

      {/* Grid de Tarjetas */}
      <div style={{ 
        display: 'grid', 
        gridTemplateColumns: 'repeat(auto-fit, minmax(320px, 1fr))', 
        gap: '25px'
      }}>
        <DashboardCard 
          icon="üìç"
          title="Seguimiento en Tiempo Real" 
          description="Monitorear progreso y ubicaci√≥n actual de asesores en tiempo real"
          onClick={() => navigate('/admin/tracking')}
        />
        
        <DashboardCard 
          icon="üè™"
          title="Gesti√≥n de Tiendas" 
          description="Asignar tiendas a asesores comerciales y gestionar puntos de venta"
          onClick={() => navigate('/admin/stores')}
        />
        
        <DashboardCard 
          icon="üìä"
          title="M√©tricas y Estad√≠sticas" 
          description="Ver datos de productos, ventas y m√©tricas de desempe√±o"
          onClick={() => navigate('/admin/metrics')}
        />
      </div>

      {/* Resumen R√°pido */}
      <div style={{
        marginTop: '50px',
        padding: '20px',
        backgroundColor: '#ffffff',
        borderRadius: '12px',
        border: '1px solid #e1e5e9'
      }}>
        <h3 style={{ margin: '0 0 15px 0', color: '#1f2937' }}>
          Resumen R√°pido del Sistema
        </h3>
        
        {error && (
          <div style={{
            padding: '15px',
            backgroundColor: '#fef2f2',
            border: '1px solid #fecaca',
            borderRadius: '8px',
            marginBottom: '20px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div>
              <strong style={{ color: '#dc2626' }}>‚ö†Ô∏è Error:</strong>
              <span style={{ marginLeft: '8px', color: '#6b7280' }}>{error}</span>
            </div>
            <button 
              onClick={handleRetry}
              style={{
                padding: '8px 16px',
                backgroundColor: '#3b82f6',
                color: 'white',
                border: 'none',
                borderRadius: '6px',
                cursor: 'pointer',
                fontSize: '14px'
              }}
            >
              Reintentar
            </button>
          </div>
        )}

        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px' }}>
          <div>
            <strong style={{ color: '#3b82f6' }}>Asesores Activos:</strong>
            <span style={{ marginLeft: '8px', color: '#6b7280' }}>
              {loading ? 'Cargando...' : dashboardData?.active_advisors ?? 'N/A'}
            </span>
          </div>
          <div>
            <strong style={{ color: '#3b82f6' }}>Tiendas Hoy:</strong>
            <span style={{ marginLeft: '8px', color: '#6b7280' }}>
              {loading ? 'Cargando...' : dashboardData?.total_stores_today ?? 'N/A'}
            </span>
          </div>
          <div>
            <strong style={{ color: '#3b82f6' }}>Rutas en Progreso:</strong>
            <span style={{ marginLeft: '8px', color: '#6b7280' }}>
              {loading ? 'Cargando...' : dashboardData?.active_routes ?? 'N/A'}
            </span>
          </div>
          <div>
            <strong style={{ color: '#3b82f6' }}>Tiendas Completadas:</strong>
            <span style={{ marginLeft: '8px', color: '#6b7280' }}>
              {loading ? 'Cargando...' : dashboardData?.completed_stores ?? 'N/A'}
            </span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default AdminDashboard;